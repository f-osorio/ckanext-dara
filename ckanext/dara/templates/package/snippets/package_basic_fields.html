{#
{% ckan_extends %}
#}

{#TODO needs some refactoring. CKAN now has visibility selector in template,
that we should integrate somehow here #}

{% import 'macros/form.html' as form %}
{% import 'macros/dara_form.html' as dara_form %}

{% set c = h.dara_c %}
{#{% set dara_authors = h.dara_authors() %}#}
{% set form_style = c.form_style or c.action %}
{# {% set debug = h.dara_debug() %} #}
{% set pkg = c.pkg_dict %}


{% resource 'dara/dara.css' %}
{% resource 'dara/dara.js' %}
{% resource 'dara/jquery-ui.js' %}
{# {% resource 'dara/jquery-migrate.js' %} #}
{#{% resource 'dara/jquery-ui.css' %}#}

{% block package_basic_fields_license %}
{% endblock %}

{% block package_basic_fields_title %}
{#
{% if form_style=='edit' %}
    <h1>Edit Dataset</h1>
{% endif %}
#}
{% endblock %}

{% block package_basic_fields_url %}
{% endblock %}

{% block package_basic_fields_description %}
{% endblock %}

{% block package_metadata_author %}
{% endblock %}


{#

{% block package_basic_fields_org %}
{% endblock %}
#}


{% block package_basic_fields_tags %}
{% endblock %}

{# dara level 1 (mandatory) fields #}
{% block package_basic_fields_custom %}


<input type="hidden" value="{{ h.dara_doi(data) }}" name="dara_DOI_Proposal" />
<input type="hidden" value="{{ pkg['dara_DOI'] }}"  name="dara_DOI" />
<input type="hidden" value="{{ pkg['dara_registered'] }}"
                     name="dara_registered" />
<input type="hidden" value="{{ pkg['dara_updated'] }}"
                     name="dara_updated" />

{#
{% if form_style == 'edit' %}
    <div id="dara_1">
        <h4 class="dara_level_head"
        title="Metadata Level 1: Ensure citability">Metadata Level 1<br />
        <span style="font-size:14px;">
           Ensure citability
        </span>
        <span class="dara_level_number">1</span>
        </h4>

        <div class="dara_level">
            {% snippet "package/snippets/dara_level1.html", form=form,
                errors=errors, data=data, dara_type="dataset" %}
        </div>
    </div>

{% else %}
    {% snippet "package/snippets/dara_level1.html", form=form,
    dara_type='dataset', errors=errors, data=data %}
{% endif %}
#}

{% snippet "package/snippets/dara_level1.html", form=form,
    dara_type='dataset', errors=errors, data=data %}

{% endblock %}



{% block package_basic_fields_org %}
  {# if we have a default group then this wants remembering #}
  {% if data.group_id %}
    <input type="hidden" name="groups__0__id" value="{{ data.group_id }}" />
  {% endif %}

  {% set dataset_is_draft = data.get('state', 'draft').startswith('draft') or data.get('state', 'none') ==  'none' %}
  {% set dataset_has_organization = data.owner_org or data.group_id %}
  {% set organizations_available = h.organizations_available('read') %}
  {% set user_is_sysadmin = h.check_access('sysadmin') %}

  {% set show_organizations_selector = organizations_available %}

  {% set show_visibility_selector = dataset_has_organization or (organizations_available and (user_is_sysadmin or dataset_is_draft)) %}

  {% if show_organizations_selector and show_visibility_selector %}
    <div data-module="dataset-visibility">
  {% endif %}

{# XXX organization selector in dara_level1.html #}

  {% if show_visibility_selector %}
    {% block package_metadata_fields_visibility %}

      {# we need to set this as hidden but with a value for members. Otherwise
        default will be 'Public'
        TODO: optimize. Perhaps overwrite the JS module?
        #}
        {% if h.check_journal_role(data, 'member') %}
          <div style="visibility: hidden">
        {% endif %}

      <div class="control-group">
        <label for="field-private" class="control-label">{{ _('Visibility') }}</label>
        <div class="controls">
          <select id="field-private" name="private">
            {% for option in [('True', _('Private')), ('False', _('Public'))] %}
            <option value="{{ option[0] }}" {% if option[0] == data.private|trim %}selected="selected"{% endif %}>
                {{ option[1] }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      {% if h.is_journal_member(data, 'member') %}
        </div>
      {% endif %}

    {% endblock %}
  {% endif %}

  {% if show_organizations_selector and show_visibility_selector %}
    </div>
  {% endif %}


  {% if data.id and h.check_access('package_delete', {'id': data.id}) and data.state != 'active' %}
    <div class="control-group">
      <label for="field-state" class="control-label">{{ _('State') }}</label>
      <div class="controls">
        <select id="field-state" name="state">
          <option value="active" {% if data.get('state', 'none') == 'active' %} selected="selected" {% endif %}>{{ _('Active') }}</option>
          <option value="deleted" {% if data.get('state', 'none') == 'deleted' %} selected="selected" {% endif %}>{{ _('Deleted') }}</option>
        </select>
      </div>
    </div>
  {% endif %}

{% endblock %}
